<ng-container *rxLet="state$; let s">
  <p-table
    class="attachment-list"
    [value]="s.files"
    [scrollable]="true"
    scrollHeight="320px"
    autoLayout="true"
    dataKey="guid"
  >
    <!-- 'let-columns' allows access to the ng-template context columns property-->
    <ng-template pTemplate="header">
      <tr>
        <th>Name</th>
        <th>Last Modified</th>
        <th>Size</th>
        <th>Action</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-file>
      <tr>
        <td>
          <p-inplace [active]="hasUnsavedFileName(file)">
            <ng-template pTemplate="display">
              {{ file.name }}
            </ng-template>
            <ng-template pTemplate="content">
              <div class="p-fluid p-grid p-formgrid">
                <div class="p-col p-field p-mb-0">
                  <input
                    pInputText
                    type="text"
                    [value]="file.name"
                    (input)="
                      changedFileName$.next({
                        file: file,
                        value: $event.target.value
                      })
                    "
                  />
                </div>
                <div class="p-col-fixed" style="width: 50px;">
                  <button
                    pButton
                    icon="pi pi-check"
                    type="button"
                    (click)="renameFile(file)"
                  ></button>
                </div>
              </div>
            </ng-template>
          </p-inplace>
        </td>
        <td>
          {{ file.lastModified | date: 'd MMMM y' }}
        </td>
        <td>{{ file.size }}&nbsp;KB</td>
        <td>
          <div class="action-button-wrapper">
            <button
              pButton
              pRipple
              type="button"
              (click)="triggerDownload(file.guid)"
              icon="pi pi-download"
              class="p-button-rounded p-button-text p-button-lg"
            ></button>
          </div>
          <div class="action-button-wrapper">
            <button
              pButton
              pRipple
              type="button"
              *ngIf="previewAllowed(file.name)"
              icon="pi pi-image"
              (click)="openFilePreview(file)"
              class="p-button-rounded p-button-text p-button-info p-button-lg"
            ></button>
          </div>
          <div class="action-button-wrapper">
            <button
              pButton
              pRipple
              type="button"
              (click)="onDeleteFile(file)"
              icon="pi pi-trash"
              class="p-button-rounded p-button-text p-button-danger p-button-lg"
            ></button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <ng-container *ngIf="s.previewFile && showFilePreview">
    <p-dialog
      [(visible)]="showFilePreview"
      [resizable]="false"
      [header]="s.previewFile.name"
    >
      <div class="p-grid">
        <div class="p-col-12">
          <ng-template
            [ngIf]="s.previewFile.name.endsWith('.pdf')"
            [ngIfElse]="imagePreview"
          >
            <iframe
              [src]="
                sanitizer.bypassSecurityTrustResourceUrl(
                  downloadUrl(s.previewFile.guid)
                )
              "
              [style]="{ width: '65vw', height: '78vh' }"
            ></iframe>
          </ng-template>
          <ng-template #imagePreview>
            <img
              [src]="downloadUrl(s.previewFile.guid)"
              [alt]="s.previewFile.name"
              [style]="{ width: 'auto', height: '60vh' }"
            />
          </ng-template>
        </div>
      </div>
    </p-dialog>
  </ng-container>
</ng-container>
