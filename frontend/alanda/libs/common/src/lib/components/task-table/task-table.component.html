<ng-container *ngIf="state$ | async as s">
  <div class="p-grid">
    <div class="p-col-3">
      <p-dropdown
        [hidden]="layouts.length <= 1"
        [options]="layouts"
        [(ngModel)]="selectedLayout"
        optionLabel="displayName"
        (onChange)="onChangeLayout()"
        [style]="{ width: '100%' }"
      >
      </p-dropdown>
    </div>
    <div class="p-col table-action-buttons">
      <p-menu #menu [popup]="true" [model]="menuItems" appendTo="body"></p-menu>
      <p-button
        type="button"
        class="menu-action-button action-button"
        icon="pi pi-bars"
        (click)="menu.toggle($event)"
      ></p-button>
      <button
        (click)="toggleGroupTasks(true)"
        pButton
        type="button"
        label="My Group Tasks"
        class="p-button-rounded badge action-button"
        [ngClass]="{ 'p-button-secondary': !groupTasks }"
      ></button>
      <button
        (click)="toggleGroupTasks(false)"
        pButton
        type="button"
        label="My Tasks"
        class="p-button-rounded badge action-button"
        [ngClass]="{ 'p-button-secondary': groupTasks }"
      ></button>
    </div>
  </div>
  <div class="p-grid">
    <div class="p-col-12">
      <p-table
        *ngIf="selectedLayout && tasksData"
        #tt
        [class]="'task-table'"
        [value]="tasksData.results"
        [columns]="selectedLayout.columnDefs"
        [paginator]="true"
        [rows]="15"
        [lazy]="true"
        [totalRecords]="tasksData.total"
        (onLazyLoad)="loadTasksLazy($event)"
        [autoLayout]="autoLayout"
        [loading]="loading"
        [resizableColumns]="resizableColumns"
        [responsive]="responsive"
        [tableStyle]="tableStyle"
      >
        <ng-template pTemplate="header" let-columns>
          <tr>
            <th
              *ngFor="let col of columns"
              [pSortableColumn]="col.field"
              pResizableColumn
              [style.width]="col.width + 'px'"
            >
              <span>{{ col.displayName }}<p-sortIcon></p-sortIcon></span>
            </th>
          </tr>
          <tr>
            <th *ngFor="let col of columns">
              <p-calendar
                *ngIf="col.type && col.type === 'date'"
                (onSelect)="onDateSelect($event, col.field)"
                (onClearClick)="tt.filter('', col.field, 'equals')"
                [showButtonBar]="true"
                styleClass="p-column-filter"
                [readonlyInput]="true"
                [appendTo]="'body'"
                [dateFormat]="dateFormatPrime"
              >
              </p-calendar>
              <input
                *ngIf="!col || col.type !== 'date'"
                pInputText
                type="text"
                class="header-col-filter"
                (input)="tt.filter($event.target.value, col.field, 'contains')"
                [value]="
                  tt.filters[col.field] ? tt.filters[col.field].value : ''
                "
              />
            </th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-task let-columns="columns">
          <tr
            [pSelectableRow]="task"
            class="task-row"
            (dblclick)="openTask(task.task.formKey, task.task.task_id)"
          >
            <td
              *ngFor="let col of columns"
              [ngClass]="getCondition(task, col.template)"
              [ngClass]="{ 'action-cell': col.name === 'Action' }"
            >
              <ng-container *ngIf="col.name === 'Action'">
                <span class="p-buttonset">
                  <button
                    pButton
                    class="table-action-button"
                    type="button"
                    label="{{ task.claimLabel }}"
                    (click)="claimAction(task)"
                  ></button>
                  <button
                    pButton
                    class="table-action-button"
                    type="button"
                    icon="pi pi-arrow-circle-right"
                    pTooltip="Delegate Task"
                    (click)="openDelegationForm(task)"
                  ></button>
                </span>
              </ng-container>
              <ng-container *ngIf="col.name === 'X' && task.project">
                <span
                  style="cursor: pointer;"
                  (click)="setupProjectDetailsModalEvent$.next(task.project)"
                  ><i class="pi pi-pencil"></i
                ></span>
              </ng-container>
              <ng-template
                [ngIf]="col.name === 'Task Name'"
                [ngIfElse]="default"
              >
                <a
                  [routerLink]="
                    getTaskPath(task.task.formKey, task.task.task_id)
                  "
                  [target]="target"
                  >{{ task | nestedObject: col.field }}</a
                >
              </ng-template>
              <ng-template #default>
                <ng-container *ngIf="col.type && col.type === 'date'">
                  {{ task | nestedObject: col.field | date: dateFormat }}
                </ng-container>
                <ng-container *ngIf="!col || col.type !== 'date'">
                  {{ task | nestedObject: col.field | filter: col.filter }}
                </ng-container>
              </ng-template>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="paginatorleft"></ng-template>
        <ng-template pTemplate="paginatorright">
          <span *ngIf="tasksData.total">Total: {{ tasksData.total }}</span>
        </ng-template>
      </p-table>
    </div>
  </div>
  <p-dialog
    [visible]="showDelegateDialog"
    [modal]="true"
    [dismissableMask]="true"
    [closeOnEscape]="true"
    [closable]="true"
    [style]="{ width: '300px' }"
    [contentStyle]="{ overflow: 'visible' }"
  >
    <p-header>
      Delegate task for
    </p-header>
    <div class="p-fluid">
      <p-dropdown
        #dd
        [options]="candidateUsers"
        optionLabel="displayName"
        placeholder="Select a user"
        [filter]="true"
      ></p-dropdown>
    </div>
    <p-footer>
      <p-button
        (onClick)="hideDelegateDialog()"
        styleClass="p-button-raised p-button-info"
        label="Cancel"
      ></p-button>
      <p-button
        (onClick)="delegateTask(dd.value)"
        styleClass="p-button-raised p-button-success"
        [disabled]="!dd.value"
        label="Delegate"
      ></p-button>
    </p-footer>
  </p-dialog>
  <!-- Project Details Modal-->
  <p-dialog
    [visible]="s.showProjectDetailsModal"
    [modal]="true"
    [style]="{ width: '500px' }"
  >
    <p-header>
      Edit Project
    </p-header>
    <alanda-task-table-project-details
      [project]="s.selectedProject"
      (close)="closeProjectDetailsModalEvent$.next($event)"
    >
    </alanda-task-table-project-details>
  </p-dialog>
</ng-container>
