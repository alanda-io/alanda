<p-panel #tt [toggleable]="true" (onAfterToggle)="loadProjectAndProcesses(tt.collapsed)" styleClass="pap-panel">
  <p-header>
    <span class="ui-panel-title title">Projects & Processes</span>
  </p-header>
  <p-treeTable
    [autoLayout]="true"
    [value]="data"
    [lazy]="true"
    [loading]="loading"
    (onNodeExpand)="onNodeExpand($event)">
    <ng-template pTemplate="header">
      <tr>
        <th>Process / Task</th>
        <th>Ref. Object</th>
        <th>Assignment</th>
        <th>Start</th>
        <th>End</th>
        <th>Comments</th>
        <th>Action</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-rowNode let-rowData="rowData">
      <tr class="content-row">
        <ng-container
          [ngTemplateOutlet]="!rowData.dropdown ? defaultNode : newProcessNode"
          [ngTemplateOutletContext]="{ rowData: rowData, rowNode: rowNode }">
            <ng-template #defaultNode>
            <td>
              {{ rowData.template }}
              <p-treeTableToggler [rowNode]="rowNode"></p-treeTableToggler>
              <span [ngClass]="getIconClass(rowData.type)"></span>
              <a *ngIf="rowData.routerLink" [routerLink]="rowData.routerLink">
                {{ rowData.label }}
              </a>
              <span *ngIf="!rowData.routerLink"> {{ rowData.label }}</span>
            </td>
            <td>{{ rowData.refObject }}</td>
            <td>{{ rowData.assignee }}</td>
            <td>{{ rowData.start | date: dateFormat }}</td>
            <td>{{ rowData.end | date: dateFormat }}</td>
            <td>{{ rowData.comment }}</td>
          </ng-template>
        </ng-container>
        <td class="col-action">
          <alanda-pap-actions
            [config]="actionsConfig[rowData.uuid] || {}"
            [status]="rowData.status"
            (createSubproject)="createSubproject(rowData)"
            (relateMeTo)="relateMeTo(rowData)"
            (unrelateMe)="unrelateMe(rowData)"
            (moveMeTo)="moveMeTo(rowData)"
            (relateSubproject)="relateSubproject(rowData)"
            (cancelProject)="openCancelProjectDialog(rowData)"
            (cancelProcess)="openCancelProcessDialog(rowData, rowNode.node)"
            (removeSubprocess)="openRemoveProcessDialog(rowData, rowNode.node)"
            (startSubprocess)="openStartProcessDialog(rowData, rowNode.node)"
            (configureProcess)="configureProcess(rowData, rowNode.node.parent.data.project)"
            >
          </alanda-pap-actions>
        </td>
      </tr>
    </ng-template>
  </p-treeTable>
</p-panel>

<ng-template #newProcessNode let-rowData="rowData" let-rowNode="rowNode">
  <td class="col-process-dropdown">
    <p-dropdown
      styleClass="pap-input"
      [options]="allowedProcesses[rowNode.parent.data.project.guid]"
      [(ngModel)]="rowData.process"
      (onChange)="subprocessSelect$.next({data: rowData, parent: rowNode.parent})"
      placeholder="-- Select Process --"
      dataKey="processKey"
      appendTo="body"
      optionLabel="label">
    </p-dropdown>
  </td>
  <td class="col-process-input">
    <p-dropdown
      styleClass="pap-input"
      [disabled]="true"
      placeholder="Reference Object"
      >
    </p-dropdown>
  </td>
  <td colspan="4" class="col-process-input">
    <input
      styleClass="pap-input"
      type="text"
      placeholder="Details"
      [disabled]="true"
      pInputText />
  </td>
</ng-template>

<p-dialog [(visible)]="displayCancelProjectDialog" [modal]="true">
  <p-header> {{ dialogData.title }} </p-header>
  <p>
    {{ dialogData.content }}
  </p>
  <textarea
    pInputTextarea
    [(ngModel)]="dialogData.reason"
    class="reason-input"
    [placeholder]="dialogData.placeholder"
  ></textarea>
  <p-footer>
    <button
      pButton
      label="Cancel"
      class="ui-button-secondary"
      (click)="displayCancelProjectDialog = false"
    ></button>
    <button
      pButton
      label="OK"
      (click)="cancelProject(); displayCancelProjectDialog = false"
    ></button>
  </p-footer>
</p-dialog>

<p-dialog [(visible)]="displayCancelProcessDialog" [modal]="true">
  <p-header> {{ dialogData.title }} </p-header>
  <p>
    {{ dialogData.content }}
  </p>
  <textarea
    pInputTextarea
    [(ngModel)]="dialogData.reason"
    class="reason-input"
    [placeholder]="dialogData.placeholder"
  ></textarea>
  <p-footer>
    <button
      pButton
      label="Cancel"
      class="ui-button-secondary"
      (click)="displayCancelProcessDialog = false"
    ></button>
    <button
      pButton
      label="OK"
      (click)="cancelProcess(); displayCancelProcessDialog = false"
    ></button>
  </p-footer>
</p-dialog>

<p-dialog [(visible)]="displayStartProcessDialog" [modal]="true">
  <p-header>
    Start
  </p-header>
  {{ dialogData.content }}
  <p-footer>
    <button pButton type="button" label="Cancel" class="ui-button-secondary" (click)="displayStartProcessDialog = false"></button>
    <button pButton type="button" label="OK" (click)="startSubprocess(); displayStartProcessDialog = false"></button>
  </p-footer>
</p-dialog>

<p-dialog [(visible)]="displayRemoveProcessDialog" [modal]="true">
  <p-header> Remove Process </p-header>
  <p>
    {{ dialogData.content }}
  </p>
  <textarea
    pInputTextarea
    [(ngModel)]="dialogData.reason"
    class="reason-input"
    [placeholder]="dialogData.placeholder"
  ></textarea>
  <p-footer>
    <button
      pButton
      label="Cancel"
      class="ui-button-secondary"
      (click)="displayRemoveProcessDialog = false"
    ></button>
    <button
      pButton
      label="OK"
      (click)="removeSubprocess(); displayRemoveProcessDialog = false"
    ></button>
  </p-footer>
</p-dialog>
